<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scrum Poker Local Simulation</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-blue': '#1052FF',
                        'secondary-gray': '#E5E7EB',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        .card-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06); }
        .card:hover { transform: translateY(-4px) scale(1.02); }
        .card-selected {
            border-color: #1052FF;
            box-shadow: 0 0 0 4px rgba(16, 82, 255, 0.5);
            background-color: #1052FF;
            color: white;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col font-sans">

    <!-- Header -->
    <header class="bg-white shadow-md">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-primary-blue flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19.03 2.5a.5.5 0 0 0-.5.5v18a.5.5 0 0 0 .5.5H20a.5.5 0 0 0 .5-.5V3a.5.5 0 0 0-.5-.5h-1zm-4.78 1.96a.5.5 0 0 0-.5.5v15a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5V5a.5.5 0 0 0-.5-.5h-1zm-4.78 1.96a.5.5 0 0 0-.5.5v13a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5V7a.5.5 0 0 0-.5-.5h-1zm-4.78 1.96a.5.5 0 0 0-.5.5v11a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5V9a.5.5 0 0 0-.5-.5h-1z"/>
                </svg>
                Scrum Poker Local Simulation
            </h1>
            <div class="text-sm text-gray-600">
                Mode: <span class="font-mono bg-yellow-100 text-yellow-800 px-2 py-1 rounded">Local Only</span>
            </div>
        </div>
    </header>

    <!-- Main Content Area -->
    <main id="app-container" class="flex-grow p-4 sm:p-6 lg:p-8 max-w-7xl w-full mx-auto">
        <!-- Content will be dynamically swapped between Lobby and Game -->
        <div id="lobby-view">
            <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-lg mx-auto">
                <h2 class="text-3xl font-extrabold text-gray-900 mb-6 text-center">Start Local Simulation</h2>
                <p class="text-center text-sm text-red-500 mb-6 font-semibold">
                    Note: This is a single-user simulation using your browser's local storage.
                </p>
                <input id="user-name-input" type="text" placeholder="Enter your name" class="w-full px-4 py-3 border border-gray-300 rounded-lg mb-2 focus:ring-primary-blue focus:border-primary-blue transition duration-150" required>
                <p id="name-error-message" class="text-red-500 text-sm mb-4 hidden">Please enter your name to proceed.</p>

                <button id="create-game-btn" class="w-full bg-primary-blue text-white font-semibold py-3 rounded-lg shadow-md hover:bg-blue-600 transition duration-150 ease-in-out">
                    Start Local Game
                </button>

                <!-- Removed Join Game elements as they rely on a shared backend -->
                <div class="my-6 flex items-center">
                    <div class="flex-grow border-t border-gray-300"></div>
                    <span class="flex-shrink mx-4 text-gray-500">INFO</span>
                    <div class="flex-grow border-t border-gray-300"></div>
                </div>
                <p class="text-sm text-gray-500 text-center">
                    Multi-user join functionality requires a server or cloud database (like Firebase) and is disabled in this static version.
                </p>
            </div>
        </div>

        <div id="game-view" class="hidden">
            <!-- Game Content -->
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">

                <!-- Left Side: Issues & Game Info -->
                <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg border-l-4 border-primary-blue">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 flex justify-between items-center">
                        Game ID: <span id="current-game-id" class="font-mono text-sm bg-gray-100 p-1 rounded-md text-primary-blue">LOCAL-SIM</span>
                    </h3>

                    <p class="text-sm text-red-600 mb-4 font-semibold">
                        This is a local simulation. You are the only player.
                    </p>
                    
                    <h4 class="font-semibold text-lg border-b pb-2 mb-4">Issues/Stories</h4>
                    <div id="issue-list" class="space-y-2">
                        <p class="text-sm text-gray-500">Current Issue: **Design Landing Page**</p>
                        <p class="text-xs text-gray-400">Next: Build API Endpoint</p>
                    </div>
                </div>

                <!-- Main Area: Player Votes and Controls -->
                <div class="lg:col-span-3">
                    <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
                        <h3 class="text-2xl font-bold text-gray-900 mb-4">
                            <span id="game-status-text" class="text-green-600">VOTING ROUND</span>
                        </h3>
                        <p id="creator-controls" class="text-sm text-gray-600 mb-4">
                            <span class="font-bold text-primary-blue">Your Controls:</span> 
                            <button id="reveal-votes-btn" class="ml-2 px-3 py-1 bg-yellow-500 text-white text-sm rounded-lg hover:bg-yellow-600 transition disabled:opacity-50" disabled>Reveal Votes</button>
                            <button id="new-round-btn" class="ml-2 px-3 py-1 bg-green-500 text-white text-sm rounded-lg hover:bg-green-600 transition disabled:opacity-50" disabled>New Round</button>
                        </p>

                        <!-- Player Votes Grid (now showing only the local player) -->
                        <div id="player-grid" class="mt-4 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
                            <!-- Player card for the local user will be injected here -->
                        </div>
                        
                        <!-- Voting Results Summary (Hidden initially) -->
                        <div id="results-summary" class="hidden mt-6 pt-4 border-t border-gray-200">
                            <h4 class="text-xl font-bold text-primary-blue mb-3">Voting Results</h4>
                            <div id="vote-distribution" class="flex flex-wrap gap-x-6 gap-y-2 text-sm">
                                <!-- Distribution stats will go here -->
                            </div>
                        </div>

                    </div>
                    
                    <!-- Card Selection Area -->
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Select Your Estimate</h3>
                        <div id="card-selection-grid" class="grid grid-cols-4 sm:grid-cols-6 lg:grid-cols-11 gap-3">
                            <!-- Cards will be injected here -->
                        </div>
                        <div class="mt-4 flex items-center">
                             <p class="text-lg font-semibold text-gray-700">Your Current Vote:</p>
                             <span id="current-vote-display" class="ml-3 px-3 py-1 text-lg font-bold rounded-lg bg-secondary-gray text-gray-800">None</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Footer -->
    <footer class="bg-gray-800 text-white mt-auto">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 text-center text-sm">
            &copy; 2024 Scrum Poker Local Simulation. Pure static HTML/JS.
        </div>
    </footer>


    <!-- Local Storage Game Logic -->
    <script>
        // --- Game State Constants and Variables ---

        const STORAGE_KEY = 'poker_game_state';
        const CARDS = ["0", "1/2", "1", "2", "3", "5", "8", "13", "20", "40", "100", "?", "∞"];

        let gameState = {
            userName: null,
            roundStatus: 'voting', // 'voting' or 'revealed'
            players: {}, // Only contains the local player for simulation
            localVote: null,
        };

        // --- DOM Elements ---
        const lobbyView = document.getElementById('lobby-view');
        const gameView = document.getElementById('game-view');
        const userNameInput = document.getElementById('user-name-input');
        const nameErrorMessage = document.getElementById('name-error-message');
        const createGameBtn = document.getElementById('create-game-btn');
        const playerGrid = document.getElementById('player-grid');
        const cardSelectionGrid = document.getElementById('card-selection-grid');
        const revealVotesBtn = document.getElementById('reveal-votes-btn');
        const newRoundBtn = document.getElementById('new-round-btn');
        const gameStatusText = document.getElementById('game-status-text');
        const currentVoteDisplay = document.getElementById('current-vote-display');
        const resultsSummary = document.getElementById('results-summary');
        const voteDistribution = document.getElementById('vote-distribution');

        // --- Utility Functions ---

        function saveState() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(gameState));
            } catch (e) {
                console.error("Error saving state to localStorage:", e);
            }
        }

        function loadState() {
            try {
                const storedState = localStorage.getItem(STORAGE_KEY);
                if (storedState) {
                    const loadedState = JSON.parse(storedState);
                    // Only load relevant, non-sensitive parts
                    gameState.userName = loadedState.userName || null;
                    gameState.roundStatus = loadedState.roundStatus || 'voting';
                    gameState.localVote = loadedState.localVote || null;
                    // Reset players/votes to just the local player for consistency
                    gameState.players = loadedState.userName ? { 
                        'local_user': { 
                            name: loadedState.userName, 
                            hasVoted: !!loadedState.localVote, 
                            vote: loadedState.localVote, 
                            isCreator: true 
                        } 
                    } : {};
                }
            } catch (e) {
                console.error("Error loading state from localStorage:", e);
                localStorage.removeItem(STORAGE_KEY); // Clear potentially corrupted state
            }
        }

        function showView(viewId) {
            lobbyView.classList.add('hidden');
            gameView.classList.add('hidden');
            if (viewId === 'lobby') {
                lobbyView.classList.remove('hidden');
            } else if (viewId === 'game') {
                gameView.classList.remove('hidden');
            }
        }

        function showNameError(show) {
            if (show) {
                nameErrorMessage.classList.remove('hidden');
                userNameInput.classList.add('border-red-500');
            } else {
                nameErrorMessage.classList.add('hidden');
                userNameInput.classList.remove('border-red-500');
            }
        }

        // --- Game Flow Handlers ---

        function handleStartGame() {
            const name = userNameInput.value.trim();
            
            if (!name) {
                showNameError(true);
                return;
            }
            showNameError(false);

            gameState.userName = name;
            gameState.roundStatus = 'voting';
            gameState.localVote = null;
            gameState.players = {
                'local_user': { 
                    name: name, 
                    hasVoted: false, 
                    vote: null, 
                    isCreator: true 
                }
            };
            
            saveState();
            updateGameUI();
            showView('game');
        }

        // --- UI Rendering ---

        function updateGameUI() {
            const player = gameState.players['local_user'];
            const roundStatus = gameState.roundStatus;

            // 1. Update Game Status Text and Controls
            gameStatusText.textContent = roundStatus === 'voting' ? 'VOTING ROUND' : 'VOTES REVEALED';
            gameStatusText.classList.remove('text-green-600', 'text-red-600');
            gameStatusText.classList.add(roundStatus === 'voting' ? 'text-green-600' : 'text-red-600');

            // Controls logic for simulation
            revealVotesBtn.disabled = roundStatus !== 'voting' || !player.hasVoted;
            newRoundBtn.disabled = roundStatus !== 'revealed';

            // 2. Update Player Grid (Local Player Card)
            playerGrid.innerHTML = '';

            const playerElement = document.createElement('div');
            playerElement.className = 'bg-white p-4 rounded-xl shadow-md border-b-4 border-primary-blue';

            // Determine the card display
            let cardContent = ' ';
            let cardClass = 'bg-gray-200';
            if (roundStatus === 'revealed' && player.vote) {
                cardContent = player.vote;
                cardClass = 'bg-primary-blue text-white';
            } else if (player.hasVoted) {
                cardContent = roundStatus === 'voting' ? '★' : ' '; // Show star during voting
                cardClass = 'bg-green-500 text-white';
            }

            playerElement.innerHTML = `
                <div class="text-xs font-semibold text-gray-500 mb-1 flex items-center">
                    <span class="text-xs font-bold text-primary-blue mr-1">YOU (CREATOR)</span>
                    ${player.name}
                </div>
                <div class="w-full h-16 flex items-center justify-center font-extrabold text-3xl rounded-lg ${cardClass} card-shadow transition duration-150 ease-in-out">
                    ${cardContent}
                </div>
            `;
            playerGrid.appendChild(playerElement);

            // 3. Update Card Selection UI (local state)
            updateCardSelectionUI();

            // 4. Update Results Summary
            if (roundStatus === 'revealed') {
                resultsSummary.classList.remove('hidden');
                renderResultsSummary();
            } else {
                resultsSummary.classList.add('hidden');
            }
        }

        function renderResultsSummary() {
            voteDistribution.innerHTML = '';
            const vote = gameState.localVote;

            if (vote && vote !== '?' && vote !== '∞') {
                const statItem = document.createElement('div');
                statItem.className = 'flex flex-col items-center p-2 rounded-lg bg-gray-100 min-w-[60px]';
                statItem.innerHTML = `
                    <span class="text-xl font-bold text-primary-blue">${vote}</span>
                    <span class="text-xs text-gray-600">1 vote (100%)</span>
                `;
                voteDistribution.appendChild(statItem);
            } else {
                 voteDistribution.innerHTML = '<p class="text-gray-500 italic">No numeric estimate cast in this round.</p>';
            }
        }


        // --- Card Selection and Local Voting ---

        function renderCardSelection() {
            cardSelectionGrid.innerHTML = '';
            CARDS.forEach(cardValue => {
                const button = document.createElement('button');
                button.textContent = cardValue;
                button.className = `card w-full h-20 sm:h-24 flex items-center justify-center font-extrabold text-xl sm:text-3xl rounded-lg border-2 border-gray-300 bg-white text-gray-700 cursor-pointer transition duration-150 ease-in-out hover:bg-gray-100 hover:border-primary-blue card-shadow`;
                button.setAttribute('data-value', cardValue);
                button.addEventListener('click', () => selectCard(cardValue));
                cardSelectionGrid.appendChild(button);
            });
            updateCardSelectionUI();
        }

        function updateCardSelectionUI() {
            document.querySelectorAll('.card').forEach(card => {
                const value = card.getAttribute('data-value');
                card.classList.remove('card-selected');
                if (value === gameState.localVote) {
                    card.classList.add('card-selected');
                }
            });
             currentVoteDisplay.textContent = gameState.localVote || 'None';
             
             // Update vote display style
             currentVoteDisplay.classList.remove('bg-secondary-gray', 'bg-primary-blue', 'text-white', 'text-gray-800'); 
             if (gameState.localVote) {
                 currentVoteDisplay.classList.add('bg-primary-blue', 'text-white');
             } else {
                 currentVoteDisplay.classList.add('bg-secondary-gray', 'text-gray-800');
             }
        }

        function selectCard(value) {
            if (gameState.roundStatus !== 'voting') {
                alertModal("Votes are already revealed. Click 'New Round' to vote again.");
                return;
            }

            gameState.localVote = value;
            gameState.players['local_user'].vote = value;
            gameState.players['local_user'].hasVoted = true;
            
            saveState();
            updateGameUI();
        }

        // --- Control Actions (Reveal/Reset) ---

        function handleControlAction(action) {
            if (action === 'reveal' && gameState.roundStatus === 'voting' && gameState.players['local_user'].hasVoted) {
                gameState.roundStatus = 'revealed';
            } else if (action === 'reset' && gameState.roundStatus === 'revealed') {
                gameState.roundStatus = 'voting';
                gameState.localVote = null;
                gameState.players['local_user'].vote = null;
                gameState.players['local_user'].hasVoted = false;
            } else if (action === 'reveal' && !gameState.players['local_user'].hasVoted) {
                 alertModal("You must cast a vote before revealing.");
                 return;
            }
            
            saveState();
            updateGameUI();
        }

        // --- Custom Alert Modal (Replaces alert()) ---

        function alertModal(message) {
            console.warn("APP ALERT:", message);
            const alertDiv = document.createElement('div');
            alertDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            alertDiv.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-2xl max-w-sm mx-auto z-[60]">
                    <h5 class="text-xl font-bold mb-3 text-red-600">Action Required</h5>
                    <p class="text-gray-700 mb-4">${message}</p>
                    <button id="close-alert-btn" class="w-full bg-primary-blue text-white py-2 rounded-lg hover:bg-blue-600">Close</button>
                </div>
            `;
            document.body.appendChild(alertDiv);
            document.getElementById('close-alert-btn').onclick = () => alertDiv.remove();
        }


        // --- Initialization ---

        function initApp() {
            loadState();

            // Set up event listeners
            createGameBtn.addEventListener('click', handleStartGame);
            revealVotesBtn.addEventListener('click', () => handleControlAction('reveal'));
            newRoundBtn.addEventListener('click', () => handleControlAction('reset'));

            renderCardSelection();

            // Decide which view to show on load
            if (gameState.userName) {
                userNameInput.value = gameState.userName;
                updateGameUI();
                showView('game');
            } else {
                showView('lobby');
            }
        }

        // Initialize the application when the window loads
        window.onload = initApp;

    </script>
</body>
</html>
